<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>无标题文档</title>
</head>

<body>
<script type="text/javascript" src="d3-cookbook/node_modules/d3/d3.js"></script>
<script>
    //画布大小
    var width = 600;
    var height = 600;

    //在 body 里添加一个 SVG 画布
    var svg = d3.select("body")
            .append("svg")
            .attr("width", width)
            .attr("height", height);
    var nodes = [
        { name: "桂林" },
        { name: "广州" },
        { name: "厦门" },
        { name: "杭州" },
        { name: "上海" },
        { name: "青岛" },
        { name: "天津" },
        { name: "江西" },
        { name: "江苏" },
        { name: "北京" },
        { name: "广州" },
        { name: "内蒙" },
        { name: "香港" },
        { name: "澳门" },
        { name: "呼和浩特"},
        { name: "新疆" },
        { name: "西藏" },
        { name: "青海" },
        { name: "穆思丽"},
        { name: "阿拉善" },
        { name: "重庆" },
        { name: "四川" }
    ];

    /*<defs>
     <marker id="arrow"
     markerUnits="strokeWidth"
     markerWidth="12"
     markerHeight="12"
     viewBox="0 0 12 12"
     refX="6"
     refY="6"
     orient="auto">
     <path d="M2,2 L10,6 L2,10 L6,6 L2,2" style="fill: #000000;" />
     </marker>
     </defs>*/
    var defs = svg.append('defs').append('marker');
    var marker = defs.attr('id','arrow')
            .attr('markerUnits','strokeWidth')
            .attr('markerWidth',12)
            .attr('markerHeight',12)
            .attr('viewBox','0 0 12 12')
            .attr('refX',50)
            .attr('refY',50)
            .attr('orient','auto');
    marker.append('path').attr('d','M2,2 L10,6 L2,10 L6,6 L2,2').style('fill:#f60');
    var edges = [ { source : 0 , target: 1 } , { source : 0 , target: 2 } ,
        { source : 0 , target: 3 } , { source : 1 , target: 4 } ,{ source : 1 , target: 3 },
        { source : 1 , target: 5 } , { source : 1 , target: 6 },{ source : 3 , target: 1 } ];

    var force = d3.layout.force()
            .nodes(nodes) //指定节点数组
            .links(edges) //指定连线数组
            .size([width,height]) //指定作用域范围
            .linkDistance(150) //指定连线长度
            .charge([-400]); //相互之间的作用力
    force.start();    //开始作用

    //添加连线
    var svg_edges = svg.selectAll("line")
            .data(edges)
            .enter()
            .append("line").attr('marker-end','url(#arrow)')
            .style("stroke","#ccc")
            .style("stroke-width",1).attr('x1',function( d ){

            });
    var color = d3.scale.category20();
    function addnode(){
        //添加节点
        svg_nodes = svg.selectAll("g")
                .data(nodes)
                .enter()
                .append("g").attr('x',function(d){
                    return d.x;
                    console.log(d)
                }).attr('y',function(d){
                    return d.y;
                    console.log(d)
                }).call(force.drag);   //使得节点能够拖动
        //添加描述节点的文字
        svg_texts = svg_nodes
                .append("text")
                .style("fill", "black")
                .attr("dx", 0)
                .attr("dy", 0)
                .text(function(d){
                    return d.name;
                });
        svg_nodes.each(function(){
            var warp = this.getBBox();
            var node = d3.select(this);
            console.log(node,warp);
            node.attr('width',warp.width).attr('height',warp.height).attr();
            node.append('rect').attr('width',warp.width).attr('height',warp.height).attr('x',node.attr('x')).attr('y',node.attr('y')).style('file','red');
        });

    }
    addnode();


    force.on("tick", function(){ //对于每一个时间间隔
        addnode();
        //更新连线坐标
        svg_edges.attr("x1",function(d){ return d.source.x; })
                .attr("y1",function(d){ return d.source.y; })
                .attr("x2",function(d){ return d.target.x; })
                .attr("y2",function(d){ return d.target.y; });

        //更新节点坐标
        svg_nodes.attr("x",function(d){ return d.x; })
                .attr("y",function(d){ return d.y; });

        //更新文字坐标
        svg_texts.attr("x", function(d){ return d.x; })
                .attr("y", function(d){ return d.y; });
    });
</script>
</body>
</html>
